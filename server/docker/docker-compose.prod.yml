version: '3.8'

services:
  redis:
    image: redis:7-alpine
    container_name: llmvpn-redis-prod
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
      - ./redis.conf:/usr/local/etc/redis/redis.conf:ro
    command: redis-server /usr/local/etc/redis/redis.conf
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 30s
      timeout: 3s
      retries: 3
    networks:
      - llmvpn-network

  vault:
    image: hashicorp/vault:1.15
    container_name: llmvpn-vault-prod
    ports:
      - "8200:8200"
    volumes:
      - vault_data:/vault/data
      - vault_config:/vault/config
      - vault_logs:/vault/logs
    environment:
      - VAULT_LOCAL_CONFIG=${VAULT_CONFIG:-'{"storage":{"file":{"path":"/vault/data"}},"listener":{"tcp":{"address":"0.0.0.0:8200","tls_disable":true}},"ui":true,"api_addr":"http://localhost:8200"}'}
      - VAULT_ADDR=http://localhost:8200
    cap_add:
      - IPC_LOCK
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 30s
    networks:
      - llmvpn-network

  key-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.key-server
    container_name: llmvpn-key-server
    depends_on:
      redis:
        condition: service_healthy
      vault:
        condition: service_healthy
    environment:
      - KEY_SERVER_REDIS_URL=redis://redis:6379/1
      - VAULT_ADDR=http://vault:8200
      - VAULT_TOKEN=${VAULT_TOKEN}
      - KEY_CONFIG_FILE=/app/config/api_keys.csv
      - KEY_SERVER_SOCKET=/tmp/keyserver.sock
    volumes:
      - ./config:/app/config:ro
      - key_server_socket:/tmp
      - key_server_logs:/app/logs
    restart: unless-stopped
    networks:
      - llmvpn-network

  web-server:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web-server
    container_name: llmvpn-web-server
    ports:
      - "${WEB_SERVER_PORT:-8000}:8000"
    depends_on:
      - key-server
    environment:
      - WEB_SERVER_REDIS_URL=redis://redis:6379/0
      - KEY_SERVER_SOCKET=/tmp/keyserver.sock
      - PROVIDER_FILE=/app/config/providers.yaml
      - WEB_SERVER_HOST=0.0.0.0
      - WEB_SERVER_PORT=8000
    volumes:
      - ./config:/app/config:ro
      - key_server_socket:/tmp
      - web_server_logs:/app/logs
    restart: unless-stopped
    networks:
      - llmvpn-network

volumes:
  redis_data:
    driver: local
  vault_data:
    driver: local
  vault_config:
    driver: local
  vault_logs:
    driver: local
  key_server_socket:
    driver: local
  key_server_logs:
    driver: local
  web_server_logs:
    driver: local

networks:
  llmvpn-network:
    driver: bridge
    name: llmvpn-network 